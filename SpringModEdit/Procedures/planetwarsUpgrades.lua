upgradeDefs = {
	Buildings = {
		Defense = {
			[1] = {
				Arm = {
					description = "LLT or 2 Defenders",
					{'armllt', 1},
					{'armrl', 2},
					{'armrad', 1},
					{'armsonar', 1},
				},
				Core = {
					description = "LLT or 2 Pulverizer",
					{'corllt', 1},
					{'corrl', 2},
					{'corrad', 1},
					{'corsonar', 1},
				},
			},
			[2] = {
				Arm = {
					description = "Stardust, Farraday, Packo, Jammer, Torpedo Launcher",
					{'armdeva', 1},
					{'armartic', 1},
					{'armarch', 1},
					{'armjamt', 1},
					{'armtl', 1},	
				},
				Core = {
					description = "Scorcher, Razors Kiss, Aegis, Torpedo Launcher",
					{'corpre', 1},
					{'corrazor', 1},
					{'corjamt', 1},
					{'cortl', 1},	
				},
			},
			[3] = {
				Arm = {
				description = "HLT, Pitbull",
					{'armhlt', 1},
					{'armpb', 1},
				},
				Core = {
					description = "HLT, Pitbull",
					{'corhlt', 1},
					{'corvipe', 1},
				},
			},
			[4] = {
				Arm = {
					description = "Chainsaw, Adv Radar, Adv Jammer",
					{'armcir', 1},
					{'armarad', 1},
					{'armveil', 1},
				},
				Core = {
					description = "Flak, Adv Radar, Adv Jammer",
					{'corflak', 1},
					{'corarad', 1},
					{'corshroud', 1},
				},
			},
			[5] = {
				Arm = {
					description = "Advanced Defenses",
					{'armanni', 1},
					{'armamd', 1},
					{'mercury', 1},
					{'armgate', 1},
					{'armemp', 1},
				},
				Core = {
					description = "Advanced Defense",
					{'cordoom', 1},
					{'corfmd', 1},
					{'screamer', 1},
					{'corgate', 1},
					{'cortron', 1},
				},
			},
		},
		Economy = {
			[1] = {
				Arm = {
					description = "2 Basic mex/energy",
					{'armmex', 2},
					{'armsolar', 2},
					{'armwin', 2},
					{'armtide', 2},						
				},
				Core = {
					description = "2 Basic mex/energy",
					{'cormex', 2},
					{'corsolar', 2},
					{'corwin', 2},
					{'armtide', 2},			
				},
			},
			[2] = {
				Arm = {
					description = "Twilight, Nanotower, Air Pad",
					{'armamex', 1},
					{'armnanotc', 1},
					{'armasp', 1},
				},
				Core = {
					description = "Exploiter, Nanotower, Air Pad",
					{'corexp', 1},
					{'cornanotc', 1},
					{'corasp', 1},
				},
			},
			[3] = {
				Arm = {
					description = "Light Lab",
					{'armlab', 1},
					{'armvp', 1},
					{'armsy', 1},
					{'armfhp', 1},
				},
				Core = {
					description = "Light Lab",
					{'corlab', 1},
					{'corvp', 1},
					{'corsy', 1},
					{'corfhp', 1},
				},
			},
			[4] = {
				Arm = {
					description = "Fusion, Heavy, Special and Air Labs",
					{'armfus', 1},
					{'armalab', 1},
					{'armavp', 1},
					{'armap', 1},
					{'armaap', 1},
				},
				Core = {
					description = "Fusion, Heavy Lab",
					{'corfus', 1},
					{'coralab', 1},
					{'coravp', 1},
					{'corap', 1},
					{'coraap', 1},
				},
			},
			[5] = {
				Arm = {
					description = "Advanced Fusion",
					{'aafus', 1},
				},
				Core = {
					description = "Advanced Fusion",
					{'cafus', 1},
				},
			},
		},
	Apocalyptic = {
			[6] = {
				Arm = {
					description = "Nuclear Silo or Big Bertha",
					{'armsilo', 1},
					{'armbrtha', 1},
				},
				Core = {
					description = "Nuclear Silo or Intimidator",
					{'corsilo', 1},
					{'corint', 1},
				},
			},
		},
	},
	Units = {
		Bots = {
			[1] = {
				Arm = {
					description = "Peewee, 4 Fleas",
					{'armflea', 4},
				},
				Core = {
					description = "AK, 9 Cloggers",
					{'corclog', 9},
				},
			},
			[2] = {
				Arm = { description = "A bot under 150 in cost" },
				Core = { description = "A bot under 150 in cost" },
			},
			[3] = {
				Arm = { description = "A bot under 350 in cost" },
				Core = { description = "A bot under 350 in cost" },
			},
			[4] = {
				Arm = { description = "A bot under 600 in cost" },
				Core = { description = "A bot under 600 in cost" },
			},
			[5] = {
				Arm = { description = "A bot under 1200 in cost" },
				Core = { description = "A bot under 1200 in cost" },
			},
		},
		Vehicles = {
			[1] = {
				Arm = { description = "A vehicle under 75 in cost" },
				Core = { description = "A vehicle under 75 in cost" },
			},
			[2] = {
				Arm = { description = "A vehicle under 150 in cost" },
				Core = { description = "A vehicle under 150 in cost" },
			},
			[3] = {
				Arm = { description = "A vehicle under 350 in cost" },
				Core = { description = "A vehicle under 350 in cost" },
			},
			[4] = {
				Arm = { description = "A vehicle under 600 in cost" },
				Core = { description = "A vehicle under 600 in cost" },
			},
			[5] = {
				Arm = { description = "A vehicle under 1200 in cost" },
				Core = { description = "A vehicle under 1200 in cost" },
			},
		},
		Air = {
			[1] = {
				Arm = { description = "A plane under 75 in cost" },
				Core = { description = "A plane under 75 in cost" },
			},
			[2] = {
				Arm = { description = "A plane under 150 in cost" },
				Core = { description = "A plane under 150 in cost" },
			},
			[3] = {
				Arm = {	description = "A plane under 350 in cost" },
				Core = { description = "A plane aunder 350 in cost" },
			},
			[4] = {
				Arm = { description = "A plane under 600 in cost" },
				Core = { description = "A plane under 600 in cost" },
			},
			[5] = {
				Arm = { description = "A plane under 1200 in cost" },
				Core = { description = "A plane under 1200 in cost" },
			},
		},
		["Ships/Hovers"] = {
			[1] = {
				Arm = { description = "A ship/hover under 75 in cost" },
				Core = { description = "A ship/hover under 75 in cost" },
			},
			[2] = {
				Arm = { description = "A ship/hover under 150 in cost" },
				Core = { description = "A ship/hover under 150 in cost" },
			},
			[3] = {
				Arm = { description = "A ship/hover under 350 in cost" },
				Core = { description = "A ship/hover under 350 in cost" },
			},
			[4] = {
				Arm = { description = "A ship/hover under 600 in cost" },
				Core = { description = "A ship/hover under 600 in cost" },
			},
			[5] = {
				Arm = { description = "A ship/hover under 1200 in cost" },
				Core = { description = "A ship/hover under 1200 in cost" },
			},
		},
	},
}
local automaticUnitExclusions = {
	'armflea',
	'corclog',
}

local automaticUnitCosts = {75, 150, 350, 600, 1200}


--------------------------------------------------------------------------------


local processedExclusions = {}

local function ProcessExclusions()
	for _,unit in pairs(automaticUnitExclusions) do
		processedExclusions[unit] = true
	end
end

local function CalculateFactions()
	Units.armcom.faction = 'Arm' --yay case
	Units.corcom.faction = 'Core'
	local function CalculateFaction(unit, faction)
		if unit.faction and not unit.commander then return end
		unit.faction = faction
		if not _G[faction..'Units'] then _G[faction..'Units'] = {} end
		_G[faction..'Units'][unit.unitname] = unit
		if unit.buildoptions then
			for _,built in pairs(unit.buildoptions) do
				CalculateFaction(Units[built], faction)
			end
		end
	end
	for _,unit in pairs(Units) do
		if unit.commander and unit.faction then CalculateFaction(unit, unit.faction) end
	end
end

local function AddToDef(division, branch, level, faction, unitsToAdd)
	for name,unit in pairs(unitsToAdd) do
		table.insert(upgradeDefs[division][branch][level][faction], {name, 1})
	end
end

local function FindFactories(searchUnits)
	local returnUnits = {}
	for name,unit in pairs(searchUnits) do
		if unit.workerTime and unit.workerTime ~= 0 and unit.yardMap then
			returnUnits[unit.unitname] = unit
		end
	end
	return returnUnits
end

local function UnitsByFactoryAndCost(factories, minCost, maxCost)
	local returnUnits = {}
	for _,facname in pairs(factories) do
		for _,name in pairs(Units[facname].buildoptions) do
			local unit = Units[name]
			local cost = unit.buildCostMetal
			if unit.buildCostMetal > minCost and unit.buildCostMetal <= maxCost 
					and not processedExclusions[name] then
				returnUnits[unit.unitname] = unit
			end
		end
	end
	return returnUnits
end

local function AddStandardCostMobiles(division, branch, faction, factories)
	local returnUnits = {}
	local numberOfLevels = 0
	for level,_ in ipairs(automaticUnitCosts) do numberOfLevels = level end
	for level = 1,numberOfLevels do
		AddToDef(division, branch, level, faction, UnitsByFactoryAndCost(factories, automaticUnitCosts[level-1] or 0, automaticUnitCosts[level]))
	end
end

local function PrintDefs(defs)
	Editor.Echo('\n\n#light\n\n')
	Editor.Echo('namespace FSharpShared\n\n')
	Editor.Echo('open System.Linq\n\n')
	Editor.Echo('type Upgrades () =\n\n')
	Editor.Echo('   static let upgradeDefs =\n   [\n\n')
	for division,dtable in pairs(defs) do
		for branch,btable in pairs(dtable) do
			for level,ltable in pairs(btable) do
				for faction,def in pairs(ltable) do
					if def[1] then
						Editor.Echo('      new UpgradeDef(\n')
						Editor.Echo('         division = "'..division..'",\n')
						Editor.Echo('         branch = "'..branch..'",\n')
						Editor.Echo('         level = '..level..',\n')
						Editor.Echo('         factionName = "'..faction..'",\n')
						Editor.Echo('         description = "'..def.description..'",\n')
						Editor.Echo('         unitDefs = [\n')
						for _,unit in ipairs(def) do
							local unitType, number = unpack(unit)
							local unitDef = Units[unitType]
							if not unitDef then error(unitType..' not found: '..branch..' '..level) end
							local name = unitDef.name or unitType
							Editor.Echo('            new UnitDef("'..unitType..'", "'..name..'", '..number..');\n')
						end
						Editor.Echo('         ].ToList() );\n\n')
					end
				end
			end
		end
	end
	Editor.Echo('   ].ToList()\n\n')
	Editor.Echo('   member x.UpgradeDefs = upgradeDefs\n\n\n')
end


--------------------------------------------------------------------------------


CalculateFactions()
ProcessExclusions()

-- AddToDef('Buildings', 'Economy', 3, 'Arm', FindFactories(ArmUnits))
-- AddToDef('Buildings', 'Economy', 3, 'Core', FindFactories(CoreUnits))

AddStandardCostMobiles('Units', 'Bots', 'Arm', {'armlab', 'armalab'})
AddStandardCostMobiles('Units', 'Bots', 'Core', {'corlab', 'coralab'})
AddStandardCostMobiles('Units', 'Vehicles', 'Arm', {'armvp', 'armavp'})
AddStandardCostMobiles('Units', 'Vehicles', 'Core', {'corvp', 'coravp'})
AddStandardCostMobiles('Units', 'Air', 'Arm', {'armap', 'armaap'})
AddStandardCostMobiles('Units', 'Air', 'Core', {'corap', 'coraap'})
AddStandardCostMobiles('Units', 'Ships/Hovers', 'Arm', {'armsy', 'armfhp'})
AddStandardCostMobiles('Units', 'Ships/Hovers', 'Core', {'corsy', 'corfhp'})

PrintDefs(upgradeDefs)
